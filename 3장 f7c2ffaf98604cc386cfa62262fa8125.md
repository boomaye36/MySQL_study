# 3장

- MySQL 엔진
    - 클라이언트로부터의 접속 및 쿼리 요청을 처리하는 커넥션 핸들러
    - SQL 파서 및 전처리기
    - 쿼리의 최적화된 실행을 위한 옵티마이저
- MySQL 서버는 프로세스 기반이 아니라 스레드 기반
- 포그라운드 스레드(클라이언트 스레드)
    - 포그라운드 스레드는 최소한 Mysql 서버에 접속된 클라이언트의 수만큼 존재하며 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리하는 것이 임무.
    - 일정 숫자만 캐시에 존재 (thread_cache_size)
- 백그라운드 스레드
    - 인서트 버퍼를 병합하는 스레드
    - 로그를 디스크로 기록하는 스레드
    - InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
    - 데이터를 버퍼로 읽어들이는 스레드
    - 여러가지 잠금이나 데드락을 모니터링하는 스레드
    - ⇒ 매인 스레드 존재
- sql 처리 도중 데이터의 쓰기 작업은 지연되어 처리될 수 있지만 데이터의 읽기 작업은 지연될 수 없다.

### 메모리 영역

- 글로벌 메모리 영역 : 하나의 메모리 공간에 할당, 모든 스레드에 의해 공유
- 로컬 메모리 영역 : 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역

- Handler → MySQL 엔진이 각 스토리지 엔진에게 보낸 명령의 횟수를 의미하는 변수

### 쿼리를 실행하는 과정

- 파서 : 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업, 오류 탐지
- 전처리기 : 파서 과정에서 만들어낸 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인
- 옵티마이저 : 사용자의 요청으로 들어온 쿼리 문장을 저렴한 비용으로 가장 빠르게 처리할지 결정하는 역할
- 실행 엔진 : 만들어진 계획대로 각 핸들러에게 요청해서 받은 결과를 또 다른 핸들러 요청의 입력으로 연결
- 핸들러(스토리지 엔진) : MySQL 실행 엔진의 요청에 따라 데이터를 디스크로 저장하고 디스크로부터 읽어 오는 역할

### MySQL 복제

- 마스터 : 기술적으로 MySQL의 바이너리 로그가 활성화되면 어떤 MySQL서버든 마스터가 될 수 있다.
- 슬레이브 : 데이터를 받아 올 마스터 장비의 정보를 가지고 있는 경우

### 쿼리 캐시

- 쿼리 캐시는 실행된 결과를 쿼리 캐시에 담아 두고 동일한 쿼리 요청이 왔을 때 간단하게 쿼리 캐시에서 찾아서 바로 결과를 내려 줄 수 있다.

### Undo 로그

- 언두 영역은 UPDATE 문장이나 DELETE 와 같은 문장으로 데이터를 변경했을 때 변경되기 전의 데이터를 보관하는 곳이다.
- 사용자가 업데이트 문장을 실행하면 트랜잭션을 커밋하지 않아도 실제 데이터 파일 내용이 변경된다. 사용자가 커밋하게 되면 현재 상태가 그대로 유지되고 롤백하게 되면 언두 영역의 백업된 데이터를 다시 데이터파일로 복구한다.

### 인서트 버퍼

- RDBM에서 레코드가 INSERT되거나 UPDATE될 때 데이터 파일을 변경하는 작업 뿐 아니라 해당 인덱스를 업데이트 하는 작업도 필요하다.
- InnoDB는 변경해야 할 인덱스 페이지가 버퍼 풀에 있으면 바로 업데이트를 수행하지만, 디스크에서 업데이트 해야한다면 이를 즉시 실행하지 않고 임시 공간에 저장해 두고 바로 사용자에게 결과를 반환한다.

### 리두 로그 및 로그 버퍼

변경된 내용을 순차적으로 디스크에 기록하는 로그 파일

- ACID - 데이터베이스에서 트랜잭션의 무결성을 보장하기 위해 만든 4가지 요소
    
    A - 트랜잭션은 all or nothing
    
    C - 트랜잭션이 일어난 이후의 데이터베이스는 이전과 유효
    
    I - 모든 트랜잭션은 다른 트랜잭션으로부터 독립
    
    D - 하나의 트랜잭션이 성공적으로 수행되었다면 해당 트랜잭션에 대한 로그가 남아야한다. 
    

### MVCC

- MySQL 초기화 파라미터에 설정된 격리 수준에 따라 커밋이나 롤백 이전 상태에서 사용자가 변경된 레코드를 조회하면 InnoDB 버퍼 풀이나 데이터 파일 또는 언두 영역의 데이터를 반환 할 수 있다.

### NDB

- 무공유 클러스터링 : 데이터를 저장하는 스토리지가 분산되어 하나가 멈춰도 서비스에 지장없음
- 메모리 기반 스토리지 엔진
- 분산된 데이터 저장소간의 동기 복제 : 마스터 - 슬레이브 방식은 비동기 방식
- NOSQL
- NDB의 성능은 SQL 노드가 많아지면 증가한다.
- 메모리의 양이 고정적이고 회원이 어떠한 요청을 할 때마다 그 회원이 로그인 했는지 여부를 확인하는 세션 방식에서 많이 쓰인다.

### TokuDB

- 빠르게 증가하는 대용량 데이터를 관리하는 것이 주 특기
    - SNS기반의 대용량 테이블
    - 실시간 웹 페이지 클릭 분석
    - 웹 서버나 게임 서버의 로그 분석
    - 고성능 웹 크롤링
    - 데이터웨어 하우스

### 에러 로그 파일

- MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일

### 제너럴 쿼리 로그 파일

서버에서 실행되는 쿼리로 어떤 것 들이 있는지 확인하는 로그파일

### 슬로우 쿼리 로그

컨피규레이션에 정의한 시간 이상의 시간이 소요된 쿼리가 모두 기록 → 성능 저하 검사하거나 정기 점검을 위한 튜닝에 용이

### 바이너리 로그와 릴레이 로그

바이너리 로그 파일은 마스터 MySQL 서버에 생성되고 릴레이 로그는 슬레이브 MySQL 서버에 생성된다.