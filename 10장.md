# 10장

# 파티션

파티션이란 MySQL 서버의 입장에서 데이터를 별도의 테이블로 분리해서 저장하지만 사용자 입장에서는 여전히 하나의 테이블로 분리해서 읽기와 쓰기를 할 수 있게 해주는 솔루션이다. 

### 파티션을 사용하는 경우

1. 단일 INSERT와 단일 또는 범위 SELECT의 빠른 처리
- 데이터와 인덱스를 조각화해서 물리적 메모리를 효율적으로 사용할 수 있게한다.
1. 데이터의 물리적인 저장소를 분리
2. 로그 데이터의 효율적인 관리
- 로그 데이터를 파티션 테이블로 관리한다면 불필요한 데이터 삭제 작업을 파티션을 추가하거나 삭제하는 방식으로 처리할 수 있다.

### 파티션 테이블의 레코드 INSERT

INSERT 쿼리가 실행되면 MySQL 서버는 INSERT되는 칼럼의 값 중에서 파티션 키인 reg_date 칼럼의 값을 이용해 파티션 표현식을 평가하고 그 결과를 이용해 레코드가 저장될 적절한 파티션을 결정한다. 

### 파티션 테이블의 UPDATE

UPDATE 쿼리를 실행하려면 변경 대상 레코드가 어느 파티션에 저장돼 있는지 찾아야 한다. 

WHERE 조건에 파티션 키 칼럼이 조건으로 존재하면 빠르게 찾을 수 있다. 

### 파티션 테이블의 검색

파티션 테이블에서 검색할 때 영향을 미치는 요소

- WHERE 절의 조건으로 검색해야 할 파티션을 선택할 수 있는가
- WHERE 절의 조건이 인덱스를 효율적으로 사용할 수 있는가

1. 파티션 선택 가능 + 인덱스 효율적 사용 가능

쿼리가 가장 효율적으로 처리될 수 있다. 파티션의 개수에 관계없이 검색을 위해 꼭 필요한 파티션의 인덱스만 레인지 스캔한다. 

1. 파티션 선택 불가 + 인덱스 효율적 사용 가능

WHERE 조건에 일치하는 레코드가 저장된 파티션을 걸러낼 수 없기 때문에 우선 테이블의 모든 파티션을 대상으로 검색해야 한다. 하지만 각 파티션에 대해서는 인덱스 레인지 스캔을 사용할 수 있기 때문에 최종적으로 테이블에 존재 하는 모든 파티션의 개수만큼 인덱스 레인지 스캔을 수행해서 검색하게 된다. 

1. 파티션 선택 가능 + 인덱스 효육적 사용 불가

검색하려는 레코드가 저장된 파티션을 선벼할 수 있기 때문에 파티션 개수에 관계없이 검색을 위해 필요한 파티션만 읽으면 된다. 

1. 모두 사용 불가 

풀 테이블 스캔 수행

### 파티션 테이블의 인덱스 스캔과 정렬

파티션 테이블에서 인덱스는 전부 로컬 인덱스에 해당한다. 모든 인덱스는 파티션 단위로 생성되며 파티션에 관계없이 테이블 전체 단위로 글로벌하게 하나의 통합된 인덱스는 지원하지 않는다. 

- 파티션 테이블에서 인덱스 스캔을 통해 레코드를 읽을 때 MySQL 서버가 별도의 정렬 작업을 수행하지는 않는다.

### 파티션과 유니크 키

종류에 관계없이 테이블에 유니크 인덱스가 있으면 파티션 키는 모든 유니크 인덱스의 일부 또는 모든 칼럼을 포함해야 한다. 

1. 테이블에서 중복을 허용하지 않는, 프라이머리 키와 유니크 인덱스만 선별한다. 
2. 프라이머리 키와 유니크 인덱스에 공통적으로 포함돼 있는 칼럼만 수집한다. 테이블에 프라이머리 키만 있다면 프라이머리 키를 구성하는 칼럼만 수집한다. 
3. 2번에서 수집한 칼럼 붕에서 일부 또는 전체를 사용한 표현식은 파티션 표현식으로 사용할 수 있다. 물론 2번 단계에서 수집한 칼럼을 별도의 표현식 없이 그대로 파티션 키로 사용할 수도 있다. 

## 파티션의 종류

### 레인지 파티션

파티션 키의 연속된 범위로 파티션을 정의하는 방법. 가장 일반적인 파티션

MAXVALUE라는 키워드를 이용해 명시되지 않은 범위의 키 값이 담긴 레코드를 저장하는 파티션을 정의할 수 있다. 

- 날짜를 기반으로 데이터가 누적되고 년도나 월 또는 일 단위로 분석하고 삭제해야 할 때
- 범위 기반으로 데이터를 여러 파티션에 균등하게 나눌 수 있을 때
- 파티션 키 위주 검색이 자주 실행될 때

### 리스트 파티션

파티션 키 값 하나하나를 리스트로 나열해야 한다. 

- 용도
    - 파티션 키 값이 코드 값이거나 카테고리와 같이 고정적일 때
    - 키 값이 연속되지 않고 정렬 순서와 관계없이 파티션을 해야 할 때
    - 파티션 키 값을 기준으로 레코드의 건수가 균일하고 검색 조건에 파티션 키가 자주 사용될 때

### 해시 파티션

MySQL에서 정의한 해시 함수에 의해 레코드가 저장될 파티션을 결정하는 방법이다. 

- 용도
    - 레인지 파티션이나 리스트 파티션으로 데이터를 균등하게 나누는 것이 어려울 때
    - 테이블의 모든 레코드가 비슷한 사용 빈도를 보이지만 테이블이 너무 커서 파티션을 적용해야 할 때
- 해시 파티션의 분리와 병합 : 대상 레코드를 모두 재분배하는 작업이 필요.

### 키 파티션

정수 타입이나 정수 값을 반환하는 표현식 뿐 아니라 거의 대부분의 데이터 타입에 대해 파티션 키를 적용할 수 있다. 

### 파티션 테이블의 실행 계획

- 파티션 프루닝 : 쿼리의 실행 계획이 수립될 때 불필요한 파티션은 모두 배제하고 꼭 필요한 파티션만을 걸러내는 과정

### 파티션에 대한 결론

어떤 파티션 종류를 사용하든 모든 파티션을 골고루 읽고 써야 하는 테이블이라면 파티션을 사용해 SELECT 기능을 향상시키기 어렵다. 그렇지만 레코드 건수가 느려져 작업이 느려지면 파티션을 고려해보자. 

- 날짜 칼럼을 이용해 레인지 파티션을 사용할 수 있고, 읽기나 쓰기 작업을 일부 파티션으로 모을 수 있다면 테이블의 크기에 상관없이 항상 파티션을 적용하는 것이 도움될 것이다.